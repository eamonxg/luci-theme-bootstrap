name: LuCI Theme Bootstrap Build & Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: build luci-theme-bootstrap ${{ matrix.pkg_type }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        pkg_type: [ipk, apk]
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Generate release body
        run: |
          COMMIT_AUTHOR=$(git show -s --format="Author: %an <%ae>")
          COMMIT_DATE=$(git show -s --date=iso-strict --format="Date: %cI")
          COMMIT_MESSAGE=$(git show -s --format="Message: %s")
          COMMIT_HASH=$(git show -s --format="Hash: %H")
          printf 'Latest commit:\n%s\n%s\n%s\n%s\n' "$COMMIT_AUTHOR" "$COMMIT_DATE" "$COMMIT_MESSAGE" "$COMMIT_HASH" > .release-body.md

      - uses: eamonxg/build-luci-package@master
        with:
          package: luci-theme-bootstrap
          pkg_type: ${{ matrix.pkg_type }}
          skip_checkout: "true"
          prep_script: |
            ./scripts/feeds update -f base luci
            ./scripts/feeds install -p luci-base
            sed -i 's|include ../../luci.mk|include $(TOPDIR)/feeds/luci/luci.mk|g' "package/$PACKAGE/Makefile" || true
          artifact_paths: |
            bin/packages/$ARCH/base/*luci-theme-bootstrap*.[ai]pk
          release_body_path: .release-body.md
